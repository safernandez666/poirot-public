# =============================================================================
# Poirot DSPM — docker compose (pre-built images from GHCR)
#
# Usage:
#   cp .env.example .env
#   docker compose up -d                       # only Poirot
#   docker compose --profile demo up -d        # Poirot + sample data sources
#   open http://localhost:8080
# =============================================================================

services:

  # Extracts default config files from the image on first run.
  init:
    image: ghcr.io/safernandez666/poirot-scanner:latest
    container_name: poirot-init
    platform: linux/amd64
    user: root
    volumes:
      - ./config:/output
    command: >
      sh -c "
        mkdir -p /output;
        [ -f /output/connection.yml ] || cp /app/connection.yml /output/connection.yml;
        [ -f /output/fingerprint.yml ] || cp /app/fingerprint.yml /output/fingerprint.yml;
        [ -f /output/.env ] || touch /output/.env;
        echo 'Config ready.';
      "
    restart: "no"

  # ============================================================================
  # CORE — always started
  # ============================================================================

  scanner:
    image: ghcr.io/safernandez666/poirot-scanner:latest
    container_name: hawk-scanner
    platform: linux/amd64
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      init:
        condition: service_completed_successfully
    env_file:
      - path: ./config/.env
        required: false
    environment:
      - PYTHONIOENCODING=utf-8
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    volumes:
      - ./config/connection.yml:/app/connection.yml
      - ./config/fingerprint.yml:/app/fingerprint.yml
      - poirot_data:/app/data
    command: tail -f /dev/null
    networks:
      - poirot-network

  dashboard:
    image: ghcr.io/safernandez666/poirot-dashboard:latest
    container_name: hawk-dashboard
    platform: linux/amd64
    security_opt:
      - no-new-privileges:false
      - seccomp:unconfined
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      init:
        condition: service_completed_successfully
      scanner:
        condition: service_started
    ports:
      - "8080:80"
    env_file:
      - path: ./config/.env
        required: false
    environment:
      - ALERTS_DB_PATH=/app/data/alerts.db
      - FINGERPRINT_PATH=/app/config/fingerprint.yml
      - CONNECTION_PATH=/app/config/connection.yml
      - FLASK_DEBUG=false
    volumes:
      - ./config/connection.yml:/app/config/connection.yml
      - ./config/fingerprint.yml:/app/config/fingerprint.yml
      - poirot_data:/app/data
      - ./config/.env:/app/.env
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - poirot-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================================================
  # DEMO profile — sample data sources with synthetic PII
  # Start with: docker compose --profile demo up -d
  # ============================================================================

  hawk-mysql:
    image: mysql:8.0
    container_name: hawk-mysql
    profiles: ["demo"]
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: pocdb
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-prootpassword"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - poirot-network

  localstack:
    image: localstack/localstack:2.2
    container_name: localstack
    profiles: ["demo"]
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=us-east-1
      - DEBUG=1
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/tmp/localstack
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - poirot-network

  redpanda:
    image: redpandadata/redpanda:v23.3.21
    container_name: redpanda
    profiles: ["demo"]
    command:
      - redpanda
      - start
      - --smp
      - "1"
      - --memory
      - 512M
      - --mode
      - dev-container
      - --default-log-level=warn
      - --kafka-addr
      - internal://0.0.0.0:9092,external://0.0.0.0:19092
      - --advertise-kafka-addr
      - internal://redpanda:9092,external://localhost:19092
    ports:
      - "19092:19092"
    networks:
      - poirot-network
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster info --brokers localhost:9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  demo-setup:
    image: ghcr.io/safernandez666/poirot-scanner:latest
    container_name: demo-setup
    profiles: ["demo"]
    platform: linux/amd64
    depends_on:
      hawk-mysql:
        condition: service_healthy
      localstack:
        condition: service_healthy
      redpanda:
        condition: service_healthy
    environment:
      - MYSQL_HOST=hawk-mysql
      - MYSQL_PORT=3306
      - MYSQL_USER=root
      - MYSQL_PASSWORD=rootpassword
      - MYSQL_DATABASE=pocdb
      - S3_ENDPOINT=http://localstack:4566
      - S3_BUCKET=poc-bucket
      - KAFKA_BOOTSTRAP_SERVERS=redpanda:9092
    command: python /app/demo_setup.py
    restart: "no"
    networks:
      - poirot-network

networks:
  poirot-network:
    driver: bridge

volumes:
  poirot_data:
  mysql_data:
  localstack_data:
